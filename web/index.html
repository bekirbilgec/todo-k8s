<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Todo</title>
    <meta name="color-scheme" content="light" />
    <style>
      :root{
        --bg:#0b1220;
        --panel:#0f1a30;
        --card:#111f3a;
        --muted:#9fb1d1;
        --text:#e9efff;
        --line:rgba(255,255,255,.10);
        --line2:rgba(255,255,255,.16);
        --good:#2ee59d;
        --warn:#ffd166;
        --bad:#ff5c5c;
        --brand:#7aa7ff;
        --brand2:#9d7aff;
        --shadow: 0 14px 40px rgba(0,0,0,.35);
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
        background:
          radial-gradient(1200px 800px at 10% -10%, rgba(122,167,255,.22), transparent 55%),
          radial-gradient(900px 700px at 95% 0%, rgba(157,122,255,.16), transparent 55%),
          radial-gradient(900px 900px at 30% 120%, rgba(46,229,157,.10), transparent 60%),
          var(--bg);
        color:var(--text);
      }
      a{color:inherit}
      .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 60px}
      .topbar{
        display:flex;align-items:center;justify-content:space-between;gap:14px;
        margin-bottom:18px;
      }
      .brand{
        display:flex;align-items:center;gap:10px;
      }
      .logo{
        width:36px;height:36px;border-radius:12px;
        background: linear-gradient(135deg, var(--brand), var(--brand2));
        box-shadow: 0 10px 24px rgba(122,167,255,.25);
      }
      .brand h1{
        margin:0;
        font-size:18px;
        letter-spacing:.2px;
        font-weight:700;
      }
      .brand small{
        display:block;
        color:var(--muted);
        margin-top:2px;
        font-size:12px;
      }

      .pillrow{
        display:flex;align-items:center;gap:10px;flex-wrap:wrap;
        justify-content:flex-end;
      }
      .pill{
        display:inline-flex;align-items:center;gap:8px;
        padding:8px 10px;border:1px solid var(--line);
        border-radius:999px;background:rgba(255,255,255,.04);
        font-size:12px;color:var(--muted);
        backdrop-filter: blur(8px);
      }
      .dot{
        width:8px;height:8px;border-radius:99px;background:var(--warn);
        box-shadow: 0 0 0 3px rgba(255,209,102,.14);
      }
      .dot.ok{background:var(--good);box-shadow: 0 0 0 3px rgba(46,229,157,.14)}
      .dot.bad{background:var(--bad);box-shadow: 0 0 0 3px rgba(255,92,92,.16)}
      .kbd{
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
        font-size:11px;color:var(--text);
        padding:2px 6px;border-radius:8px;border:1px solid var(--line2);
        background:rgba(255,255,255,.06);
      }

      .grid{
        display:grid;
        grid-template-columns: 1.2fr .8fr;
        gap:14px;
      }
      @media (max-width: 980px){
        .grid{grid-template-columns:1fr}
      }

      .card{
        background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
        border:1px solid var(--line);
        border-radius:16px;
        box-shadow: var(--shadow);
        overflow:hidden;
      }
      .card-h{
        padding:16px 16px 12px;
        border-bottom:1px solid var(--line);
        display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
      }
      .card-h h2{
        margin:0;font-size:14px;font-weight:700;letter-spacing:.2px;
      }
      .card-h p{
        margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.4;
      }
      .card-b{padding:14px 16px 16px}

      .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
      .row > *{flex:0 0 auto}
      .grow{flex:1 1 260px;min-width:240px}

      .input, .select{
        width:100%;
        padding:10px 12px;
        border-radius:12px;
        border:1px solid var(--line);
        background:rgba(255,255,255,.04);
        color:var(--text);
        outline:none;
      }
      .input::placeholder{color:rgba(233,239,255,.55)}
      .select{cursor:pointer}
      .input:focus, .select:focus{
        border-color: rgba(122,167,255,.55);
        box-shadow: 0 0 0 4px rgba(122,167,255,.16);
      }

      .btn{
        padding:10px 12px;
        border-radius:12px;
        border:1px solid var(--line);
        background:rgba(255,255,255,.06);
        color:var(--text);
        cursor:pointer;
        user-select:none;
        transition: transform .06s ease, background .12s ease, border-color .12s ease;
      }
      .btn:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.22)}
      .btn:active{transform: translateY(1px)}
      .btn.primary{
        border-color: rgba(122,167,255,.55);
        background: linear-gradient(135deg, rgba(122,167,255,.22), rgba(157,122,255,.18));
      }
      .btn.danger{
        border-color: rgba(255,92,92,.55);
        background: rgba(255,92,92,.12);
      }
      .btn.ghost{background:transparent}
      .btn:disabled{opacity:.5;cursor:not-allowed}

      .statgrid{
        display:grid;grid-template-columns: repeat(3, 1fr);
        gap:10px;
      }
      .stat{
        border:1px solid var(--line);
        background:rgba(255,255,255,.03);
        border-radius:14px;
        padding:12px;
      }
      .stat .k{font-size:11px;color:var(--muted)}
      .stat .v{font-size:18px;font-weight:800;margin-top:6px}

      .meta{
        margin-top:12px;
        color:var(--muted);
        font-size:12px;
        display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      }

      .list{
        margin:0;padding:0;list-style:none;
      }
      .item{
        border:1px solid var(--line);
        background:rgba(255,255,255,.03);
        border-radius:14px;
        padding:12px;
        display:flex;gap:12px;align-items:flex-start;justify-content:space-between;
        margin-bottom:10px;
      }
      .item-left{display:flex;gap:10px;align-items:flex-start;min-width:0}
      .check{
        margin-top:3px;
        width:18px;height:18px;
        accent-color: var(--brand);
        cursor:pointer;
      }
      .textwrap{min-width:0}
      .title{
        font-weight:650;
        line-height:1.35;
        word-break:break-word;
      }
      .title.done{opacity:.6;text-decoration:line-through}
      .sub{
        margin-top:6px;
        color:var(--muted);
        font-size:11px;
        display:flex;gap:10px;flex-wrap:wrap;
      }
      .tag{
        display:inline-flex;align-items:center;gap:6px;
        border:1px solid var(--line);
        background:rgba(255,255,255,.03);
        padding:2px 8px;border-radius:999px;
      }

      .empty{
        padding:18px;
        border:1px dashed var(--line2);
        border-radius:14px;
        color:var(--muted);
        background:rgba(255,255,255,.02);
      }

      .toast{
        position: fixed;
        right: 16px;
        bottom: 16px;
        z-index: 9999;
        display:flex;
        flex-direction:column;
        gap:10px;
        width: min(420px, calc(100vw - 32px));
      }
      .toast-item{
        border:1px solid var(--line);
        background:rgba(15,26,48,.9);
        backdrop-filter: blur(10px);
        border-radius:14px;
        padding:12px 12px;
        box-shadow: var(--shadow);
        display:flex;
        gap:10px;
        align-items:flex-start;
      }
      .toast-item .t{
        font-size:12px;
        color:var(--muted);
        line-height:1.35;
      }
      .toast-item .h{
        font-size:13px;
        font-weight:700;
        margin-bottom:4px;
      }
      .toast-item.ok{border-color: rgba(46,229,157,.35)}
      .toast-item.warn{border-color: rgba(255,209,102,.35)}
      .toast-item.bad{border-color: rgba(255,92,92,.38)}
      .spacer{height:4px}

      .skeleton{
        border-radius:12px;
        background: linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.09), rgba(255,255,255,.04));
        background-size: 200% 100%;
        animation: shimmer 1.1s infinite;
      }
      @keyframes shimmer{
        0%{background-position: 200% 0}
        100%{background-position: -200% 0}
      }
      .sk-row{height:44px;margin-bottom:10px;border:1px solid var(--line)}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Todo</h1>
            <small>Ingress arkasında aynı host üzerinden çalışır: UI /, API /v1</small>
          </div>
        </div>

        <div class="pillrow">
          <div class="pill" title="API health">
            <span class="dot" id="apiDot"></span>
            <span id="apiStatus">checking</span>
            <span class="kbd" id="reqId">req</span>
          </div>
          <a class="pill" href="/v1/docs" target="_blank" rel="noreferrer">
            Docs
            <span class="kbd">/v1/docs</span>
          </a>
        </div>
      </div>

      <div class="grid">
        <section class="card">
          <div class="card-h">
            <div>
              <h2>Todos</h2>
              <p>Arama, filtreleme, sıralama ve sayfalama. Değişiklikler anında kaydedilir.</p>
            </div>
            <div class="row">
              <button class="btn ghost" id="refreshBtn" onclick="reload()">Refresh</button>
            </div>
          </div>

          <div class="card-b">
            <div class="row">
              <input class="input grow" id="newTodo" type="text" placeholder="Yeni todo yaz ve Enter ile ekle" />
              <button class="btn primary" id="addBtn" onclick="add()">Ekle</button>
              <button class="btn" onclick="seed()">Örnek ekle</button>
            </div>

            <div class="spacer"></div>

            <div class="row">
              <input class="input grow" id="q" type="text" placeholder="Ara (q)..." />
              <select class="select" id="doneFilter">
                <option value="">Hepsi</option>
                <option value="false">Bekleyen</option>
                <option value="true">Tamamlanan</option>
              </select>

              <select class="select" id="sort">
                <option value="createdAt">createdAt</option>
                <option value="updatedAt">updatedAt</option>
                <option value="id">id</option>
              </select>

              <select class="select" id="order">
                <option value="desc">desc</option>
                <option value="asc">asc</option>
              </select>

              <select class="select" id="limitSel" title="Sayfa boyutu">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
              </select>

              <button class="btn" id="prevBtn" onclick="prev()">Prev</button>
              <button class="btn" id="nextBtn" onclick="next()">Next</button>
            </div>

            <div class="meta">
              <div id="metaLeft">loading</div>
              <div id="metaRight" class="muted">Tip: Enter ile ekle, Ctrl+K ile arama</div>
            </div>

            <div class="spacer"></div>

            <ul class="list" id="list"></ul>
            <div id="empty" class="empty" style="display:none">Kayıt yok. Yeni bir todo ekleyebilirsin.</div>

            <div id="loading" style="display:none">
              <div class="sk-row skeleton"></div>
              <div class="sk-row skeleton"></div>
              <div class="sk-row skeleton"></div>
            </div>
          </div>
        </section>

        <aside class="card">
          <div class="card-h">
            <div>
              <h2>Özet</h2>
              <p>Toplam, tamamlanan ve bekleyen todo sayıları.</p>
            </div>
          </div>

          <div class="card-b">
            <div class="statgrid">
              <div class="stat">
                <div class="k">Total</div>
                <div class="v" id="stTotal">0</div>
              </div>
              <div class="stat">
                <div class="k">Done</div>
                <div class="v" id="stDone">0</div>
              </div>
              <div class="stat">
                <div class="k">Pending</div>
                <div class="v" id="stPending">0</div>
              </div>
            </div>

            <div class="spacer"></div>

            <div class="empty">
              <div style="font-weight:700;margin-bottom:6px">Ingress notu</div>
              <div style="color:var(--muted);font-size:12px;line-height:1.5">
                Ingress arkasında UI ve API aynı host üzerinden servis edilir. Bu yüzden UI API çağrılarını relative path ile yapar: <span class="kbd">/v1</span>.
              </div>
            </div>

            <div class="spacer"></div>

            <div class="row">
              <button class="btn" onclick="copyCurl()">Curl kopyala</button>
              <button class="btn danger" onclick="dangerReset()">Hepsini sil</button>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      // Ingress arkasında aynı host üzerinden çalışmak için boş bırakılır
      const API_BASE = "";
      const V1 = API_BASE + "/v1";

      let limit = 20;
      let offset = 0;
      let lastMeta = null;
      let lastRequestId = "req";

      const el = (id) => document.getElementById(id);

      function toast(type, title, msg){
        const host = el("toast");
        const item = document.createElement("div");
        item.className = "toast-item " + (type || "warn");
        item.innerHTML = `
          <div style="min-width:0">
            <div class="h">${escapeHtml(title || "Bilgi")}</div>
            <div class="t">${escapeHtml(msg || "")}</div>
          </div>
          <button class="btn ghost" style="padding:6px 10px;margin-left:auto" aria-label="Close">Kapat</button>
        `;
        item.querySelector("button").onclick = () => item.remove();
        host.appendChild(item);
        setTimeout(() => { if(item.isConnected) item.remove(); }, 4500);
      }

      function setApiStatus(ok){
        const dot = el("apiDot");
        const st = el("apiStatus");
        if(ok === true){
          dot.className = "dot ok";
          st.textContent = "api ok";
        }else if(ok === false){
          dot.className = "dot bad";
          st.textContent = "api down";
        }else{
          dot.className = "dot";
          st.textContent = "checking";
        }
      }

      function setLoading(on){
        el("loading").style.display = on ? "block" : "none";
        el("list").style.display = on ? "none" : "block";
        el("empty").style.display = "none";
      }

      function buildUrl() {
        const q = el("q").value.trim();
        const done = el("doneFilter").value;
        const sort = el("sort").value;
        const order = el("order").value;

        const u = new URL(V1 + "/todos", window.location.origin);
        u.searchParams.set("limit", String(limit));
        u.searchParams.set("offset", String(offset));
        u.searchParams.set("sort", sort);
        u.searchParams.set("order", order);
        if (q) u.searchParams.set("q", q);
        if (done !== "") u.searchParams.set("done", done);
        return u.pathname + "?" + u.searchParams.toString();
      }

      async function apiFetch(path, opts){
        const headers = Object.assign({ "Content-Type": "application/json" }, (opts && opts.headers) || {});
        const res = await fetch(path, Object.assign({}, opts || {}, { headers }));
        const rid = res.headers.get("x-request-id");
        if(rid){
          lastRequestId = rid;
          el("reqId").textContent = "req " + rid.slice(0, 8);
        }
        return res;
      }

      async function health() {
        try {
          const r = await fetch(API_BASE + "/healthz");
          setApiStatus(r.ok);
          return r.ok;
        } catch (e) {
          setApiStatus(false);
          return false;
        }
      }

      async function loadStats() {
        try {
          const r = await apiFetch(V1 + "/todos/stats");
          if(!r.ok) return;
          const s = await r.json();
          el("stTotal").textContent = String(s.total ?? 0);
          el("stDone").textContent = String(s.done ?? 0);
          el("stPending").textContent = String(s.pending ?? 0);
        } catch (_) {}
      }

      function renderMeta(meta){
        if(!meta){
          el("metaLeft").textContent = "loading";
          return;
        }
        el("metaLeft").textContent =
          `total=${meta.total} limit=${meta.limit} offset=${meta.offset}`;
        el("prevBtn").disabled = !meta.hasPrev;
        el("nextBtn").disabled = !meta.hasNext;
      }

      function renderList(items){
        const ul = el("list");
        ul.innerHTML = "";

        if(!items || items.length === 0){
          el("empty").style.display = "block";
          return;
        }

        items.forEach(x => {
          const li = document.createElement("li");
          li.className = "item";
          const done = !!x.done;

          const created = (x.createdAt || "").slice(0,19).replace("T"," ");
          const updated = (x.updatedAt || "").slice(0,19).replace("T"," ");
          const safeText = escapeHtml(x.text || "");

          li.innerHTML = `
            <div class="item-left">
              <input class="check" type="checkbox" ${done ? "checked" : ""} />
              <div class="textwrap">
                <div class="title ${done ? "done" : ""}">${safeText}</div>
                <div class="sub">
                  <span class="tag">id <span class="kbd">${x.id}</span></span>
                  <span class="tag">created <span class="kbd">${created || "-"}</span></span>
                  <span class="tag">updated <span class="kbd">${updated || "-"}</span></span>
                </div>
              </div>
            </div>
            <div class="row" style="justify-content:flex-end">
              <button class="btn" data-act="edit">Edit</button>
              <button class="btn danger" data-act="del">Delete</button>
            </div>
          `;

          const checkbox = li.querySelector("input.check");
          checkbox.onchange = () => toggle(x.id, checkbox.checked);

          li.querySelector('[data-act="del"]').onclick = () => del(x.id);
          li.querySelector('[data-act="edit"]').onclick = () => edit(x);

          ul.appendChild(li);
        });
      }

      async function load() {
        setLoading(true);
        try{
          const r = await apiFetch(buildUrl());
          if(!r.ok){
            const t = await safeReadError(r);
            toast("bad", "Liste alınamadı", t);
            setLoading(false);
            return;
          }
          const data = await r.json();
          lastMeta = data.meta;
          renderMeta(data.meta);
          setLoading(false);
          renderList(data.items);
        }catch(e){
          setLoading(false);
          toast("bad", "Bağlantı hatası", String(e && e.message ? e.message : e));
        }
      }

      async function add() {
        const inp = el("newTodo");
        const text = inp.value.trim();
        if (!text) return;

        el("addBtn").disabled = true;
        try{
          const r = await apiFetch(V1 + "/todos", {
            method: "POST",
            body: JSON.stringify({ text })
          });
          if(!r.ok){
            const t = await safeReadError(r);
            toast("bad", "Ekleme başarısız", t);
            return;
          }
          inp.value = "";
          offset = 0;
          toast("ok", "Eklendi", "Todo oluşturuldu");
          await reload();
        } finally {
          el("addBtn").disabled = false;
        }
      }

      async function seed(){
        const items = [
          { text: "Ingress üzerinden UI yayınla" },
          { text: "API için /v1/docs kontrol et" },
          { text: "TLS ekle (cert-manager)" }
        ];
        try{
          const r = await apiFetch(V1 + "/todos/bulk", {
            method: "POST",
            body: JSON.stringify({ items })
          });
          if(!r.ok){
            const t = await safeReadError(r);
            toast("bad", "Bulk ekleme başarısız", t);
            return;
          }
          offset = 0;
          toast("ok", "Örnekler eklendi", "3 kayıt oluşturuldu");
          await reload();
        }catch(e){
          toast("bad", "Hata", String(e && e.message ? e.message : e));
        }
      }

      async function toggle(id, done) {
        try{
          const r = await apiFetch(V1 + "/todos/" + id, {
            method: "PATCH",
            body: JSON.stringify({ done })
          });
          if(!r.ok){
            const t = await safeReadError(r);
            toast("bad", "Güncelleme başarısız", t);
            return;
          }
          await reload();
        }catch(e){
          toast("bad", "Hata", String(e && e.message ? e.message : e));
        }
      }

      async function del(id) {
        if(!confirm("Bu todo silinsin mi?")) return;
        try{
          const r = await apiFetch(V1 + "/todos/" + id, { method: "DELETE" });
          if(!r.ok){
            const t = await safeReadError(r);
            toast("bad", "Silme başarısız", t);
            return;
          }
          toast("ok", "Silindi", "Todo kaldırıldı");
          await reload();
        }catch(e){
          toast("bad", "Hata", String(e && e.message ? e.message : e));
        }
      }

      async function edit(todo){
        const current = (todo && todo.text) ? String(todo.text) : "";
        const next = prompt("Todo güncelle:", current);
        if(next === null) return;
        const text = next.trim();
        if(!text) return toast("warn", "Geçersiz değer", "Text boş olamaz");

        try{
          const r = await apiFetch(V1 + "/todos/" + todo.id, {
            method: "PATCH",
            body: JSON.stringify({ text })
          });
          if(!r.ok){
            const t = await safeReadError(r);
            toast("bad", "Güncelleme başarısız", t);
            return;
          }
          toast("ok", "Güncellendi", "Todo güncellendi");
          await reload();
        }catch(e){
          toast("bad", "Hata", String(e && e.message ? e.message : e));
        }
      }

      async function safeReadError(r){
        try{
          const ct = r.headers.get("content-type") || "";
          if(ct.includes("application/json")){
            const j = await r.json();
            if(j && j.error && j.error.message) return j.error.message;
            return JSON.stringify(j);
          }
          return await r.text();
        }catch(_){
          return "Request failed";
        }
      }

      async function reload() {
        await health();
        await loadStats();
        await load();
      }

      function next() {
        if (!lastMeta || !lastMeta.hasNext) return;
        offset += limit;
        reload();
      }

      function prev() {
        if (!lastMeta || !lastMeta.hasPrev) return;
        offset = Math.max(0, offset - limit);
        reload();
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, c => ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          "\"": "&quot;",
          "'": "&#39;"
        }[c]));
      }

      function debounce(fn, ms){
        let t = null;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }

      const debouncedReload = debounce(() => { offset = 0; reload(); }, 300);

      function hookControls(){
        el("q").addEventListener("input", debouncedReload);
        el("doneFilter").addEventListener("change", () => { offset = 0; reload(); });
        el("sort").addEventListener("change", () => { offset = 0; reload(); });
        el("order").addEventListener("change", () => { offset = 0; reload(); });
        el("limitSel").addEventListener("change", () => {
          limit = Number(el("limitSel").value || 20);
          offset = 0;
          reload();
        });

        el("newTodo").addEventListener("keydown", (e) => {
          if(e.key === "Enter") add();
        });

        document.addEventListener("keydown", (e) => {
          if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
            e.preventDefault();
            el("q").focus();
          }
        });
      }

      async function copyCurl(){
        const sample = `curl -s '${window.location.origin}${V1}/todos?limit=10&offset=0' | jq .`;
        try{
          await navigator.clipboard.writeText(sample);
          toast("ok","Kopyalandı","Curl komutu panoya kopyalandı");
        }catch(_){
          toast("warn","Kopyalanamadı", sample);
        }
      }

      async function dangerReset(){
        const ok = confirm("Tüm todo kayıtlarını silmek üzeresin. Devam edilsin mi?");
        if(!ok) return;

        try{
          const r = await apiFetch(buildUrl());
          if(!r.ok) return toast("bad","Hata","Liste alınamadı");
          const data = await r.json();

          const ids = (data.items || []).map(x => x.id);
          if(ids.length === 0) return toast("warn","Bilgi","Silinecek kayıt yok");

          for(const id of ids){
            await apiFetch(V1 + "/todos/" + id, { method: "DELETE" });
          }
          offset = 0;
          toast("ok","Tamam","Mevcut sayfadaki kayıtlar silindi");
          await reload();
        }catch(e){
          toast("bad","Hata", String(e && e.message ? e.message : e));
        }
      }

      (async () => {
        // Default limit select
        limit = Number(el("limitSel").value || 20);
        hookControls();
        setApiStatus(null);
        await reload();
        setInterval(health, 5000);
      })();
    </script>
  </body>
</html>